global:
  scrape_interval: 30s
  evaluation_interval: 30s

# Recording rules for dependency mapping
rule_files:
  - /etc/prometheus/rules.yml
  - /etc/prometheus/slo_rules.yml

scrape_configs:
  # Prometheus self-monitoring
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']

  # ICMP Ping monitoring with hierarchical dependencies
  - job_name: 'blackbox-icmp'
    scrape_interval: 15s
    scrape_timeout: 10s
    metrics_path: /probe
    params:
      module: [icmp]
    static_configs:
      # Level 0: Internet (root - no parent)
      - targets: ['8.8.8.8']
        labels:
          device_name: internet
          device_type: external
          level: "0"
          probe_type: icmp
          
      # Level 1: Router (depends on internet)
      - targets: ['192.168.0.1']
        labels:
          device_name: router
          device_type: router
          depends_on: internet
          level: "1"
          probe_type: icmp
          
      # Level 2: Switch (depends on router)
      - targets: ['192.168.0.2']
        labels:
          device_name: switch
          device_type: switch
          depends_on: router
          level: "2"
          probe_type: icmp
          
      # Level 2: Access Point (depends on router)
      - targets: ['192.168.0.3']
        labels:
          device_name: accesspoint
          device_type: ap
          depends_on: router
          level: "2"
          probe_type: icmp
          
      # Level 3: PC1 (depends on switch)
      - targets: ['192.168.0.100']
        labels:
          device_name: pc1
          device_type: device
          depends_on: switch
          level: "3"
          probe_type: icmp
          
      # Level 3: PC2 (depends on switch)
      - targets: ['192.168.0.101']
        labels:
          device_name: pc2
          device_type: device
          depends_on: switch
          level: "3"
          probe_type: icmp
          
      # Level 3: Phone (depends on access point)
      - targets: ['192.168.0.102']
        labels:
          device_name: phone
          device_type: device
          depends_on: accesspoint
          level: "3"
          probe_type: icmp
          
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__address__]
        target_label: instance
      - target_label: __address__
        replacement: blackbox-exporter:9115

  # HTTP probe - Router web interface
  - job_name: 'blackbox-http'
    scrape_interval: 30s
    scrape_timeout: 10s
    metrics_path: /probe
    params:
      module: [http_2xx]
    static_configs:
      - targets:
          - http://192.168.0.1   # Router web interface
        labels:
          probe_type: http
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__address__]
        target_label: instance
      - target_label: __address__
        replacement: blackbox-exporter:9115
